<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Management Module Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>Song Management Module Test</h1>
    
    <div class="test-section">
        <h2>Module Loading Test</h2>
        <button class="test-button" onclick="testModuleLoading()">Test Module Loading</button>
        <div id="module-loading-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Song CRUD Operations Test</h2>
        <button class="test-button" onclick="testSaveEditedSong()">Test saveEditedSong()</button>
        <button class="test-button" onclick="testSaveNewSong()">Test saveNewSong()</button>
        <button class="test-button" onclick="testEditSelectedSong()">Test editSelectedSong()</button>
        <button class="test-button" onclick="testDeleteSelectedSong()">Test deleteSelectedSong()</button>
        <div id="song-crud-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Song Removal Operations Test</h2>
        <button class="test-button" onclick="testDeleteSong()">Test deleteSong()</button>
        <button class="test-button" onclick="testRemoveFromHoldingTank()">Test removeFromHoldingTank()</button>
        <button class="test-button" onclick="testRemoveFromHotkey()">Test removeFromHotkey()</button>
        <div id="song-removal-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Bulk Operations Test</h2>
        <button class="test-button" onclick="testShowBulkAddModal()">Test showBulkAddModal()</button>
        <button class="test-button" onclick="testAddSongsByPath()">Test addSongsByPath()</button>
        <button class="test-button" onclick="testSaveBulkUpload()">Test saveBulkUpload()</button>
        <div id="bulk-operations-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Integration Test</h2>
        <button class="test-button" onclick="testIntegration()">Test Full Integration</button>
        <div id="integration-log" class="log"></div>
    </div>

    <script type="module">
        // Mock dependencies for testing
        window.db = {
            prepare: (sql) => ({
                run: (...args) => ({ changes: 1, lastInsertRowid: 123 }),
                get: (id) => ({ id: id, title: 'Mock Song', artist: 'Mock Artist', filename: 'mock.mp3' }),
                iterate: () => [{ code: 'TEST', description: 'Test Category' }]
            })
        };

        window.electronAPI = {
            store: {
                get: (key) => Promise.resolve({ value: '/mock/music/directory' })
            },
            path: {
                parse: (path) => Promise.resolve({ success: true, data: { ext: '.mp3' } }),
                join: (dir, file) => Promise.resolve({ success: true, data: '/mock/path/file.mp3' })
            },
            fileSystem: {
                copy: (src, dest) => Promise.resolve({ success: true }),
                delete: (path) => Promise.resolve({ success: true }),
                readdir: (dir) => Promise.resolve({ success: true, data: ['file1.mp3', 'file2.mp3'] }),
                stat: (path) => Promise.resolve({ success: true, data: { isDirectory: () => false } })
            }
        };

        // Mock jQuery
        window.$ = (selector) => ({
            val: (value) => value || 'mocked-value',
            attr: (attr) => 'mocked-song-id',
            each: (callback) => callback.call({ attr: () => 'mocked-song-id' }),
            text: () => 'mocked-text',
            modal: (action) => console.log(`Modal ${action}`),
            append: (html) => console.log('Appended HTML'),
            remove: () => console.log('Removed element'),
            removeAttr: (attr) => console.log(`Removed attr: ${attr}`),
            html: (content) => console.log(`Set HTML: ${content}`),
            empty: () => console.log('Emptied element'),
            show: () => console.log('Showed element'),
            hide: () => console.log('Hid element'),
            find: (selector) => ({ remove: () => console.log('Removed found element') }),
            has: (element) => ({ length: 0 })
        });

        // Mock global variables and functions
        window.categories = { TEST: 'Test Category' };
        window.mm = {
            parseFile: (path) => Promise.resolve({
                format: { duration: 180 },
                common: { title: 'Mock Title', artist: 'Mock Artist' }
            })
        };
        window.path = {
            parse: (path) => ({ name: 'Mock File' }),
            extname: (path) => '.mp3',
            join: (dir, file) => '/mock/path/file.mp3'
        };
        window.uuidv4 = () => 'mock-uuid-123';
        window.customConfirm = (message, callback) => {
            console.log(`Confirm: ${message}`);
            callback();
        };
        window.searchData = () => console.log('Search data called');
        window.populateCategorySelect = () => console.log('Populate category select called');
        window.populateCategoriesModal = () => console.log('Populate categories modal called');
        window.saveHoldingTankToStore = () => console.log('Save holding tank to store called');
        window.saveHotkeysToStore = () => console.log('Save hotkeys to store called');

        // Import the module
        let songManagementModule;

        async function loadModule() {
            try {
                songManagementModule = await import('./renderer/modules/song-management/index.js');
                log('Module loaded successfully', 'success', 'module-loading-log');
                return true;
            } catch (error) {
                log(`Failed to load module: ${error.message}`, 'error', 'module-loading-log');
                return false;
            }
        }

        function log(message, type = 'info', logId = 'song-crud-log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(logId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Test functions
        window.testModuleLoading = async function() {
            log('Testing module loading...', 'info', 'module-loading-log');
            const success = await loadModule();
            if (success) {
                log('✅ All module functions are available', 'success', 'module-loading-log');
                log(`Available functions: ${Object.keys(songManagementModule).join(', ')}`, 'info', 'module-loading-log');
            }
        };

        window.testSaveEditedSong = function() {
            log('Testing saveEditedSong()...', 'info');
            try {
                const mockEvent = { preventDefault: () => {} };
                songManagementModule.saveEditedSong(mockEvent);
                log('✅ saveEditedSong() called successfully', 'success');
            } catch (error) {
                log(`❌ saveEditedSong() failed: ${error.message}`, 'error');
            }
        };

        window.testSaveNewSong = function() {
            log('Testing saveNewSong()...', 'info');
            try {
                const mockEvent = { preventDefault: () => {} };
                songManagementModule.saveNewSong(mockEvent);
                log('✅ saveNewSong() called successfully', 'success');
            } catch (error) {
                log(`❌ saveNewSong() failed: ${error.message}`, 'error');
            }
        };

        window.testEditSelectedSong = function() {
            log('Testing editSelectedSong()...', 'info');
            try {
                songManagementModule.editSelectedSong();
                log('✅ editSelectedSong() called successfully', 'success');
            } catch (error) {
                log(`❌ editSelectedSong() failed: ${error.message}`, 'error');
            }
        };

        window.testDeleteSelectedSong = function() {
            log('Testing deleteSelectedSong()...', 'info');
            try {
                songManagementModule.deleteSelectedSong();
                log('✅ deleteSelectedSong() called successfully', 'success');
            } catch (error) {
                log(`❌ deleteSelectedSong() failed: ${error.message}`, 'error');
            }
        };

        window.testDeleteSong = function() {
            log('Testing deleteSong()...', 'info', 'song-removal-log');
            try {
                songManagementModule.deleteSong();
                log('✅ deleteSong() called successfully', 'success', 'song-removal-log');
            } catch (error) {
                log(`❌ deleteSong() failed: ${error.message}`, 'error', 'song-removal-log');
            }
        };

        window.testRemoveFromHoldingTank = function() {
            log('Testing removeFromHoldingTank()...', 'info', 'song-removal-log');
            try {
                songManagementModule.removeFromHoldingTank();
                log('✅ removeFromHoldingTank() called successfully', 'success', 'song-removal-log');
            } catch (error) {
                log(`❌ removeFromHoldingTank() failed: ${error.message}`, 'error', 'song-removal-log');
            }
        };

        window.testRemoveFromHotkey = function() {
            log('Testing removeFromHotkey()...', 'info', 'song-removal-log');
            try {
                songManagementModule.removeFromHotkey();
                log('✅ removeFromHotkey() called successfully', 'success', 'song-removal-log');
            } catch (error) {
                log(`❌ removeFromHotkey() failed: ${error.message}`, 'error', 'song-removal-log');
            }
        };

        window.testShowBulkAddModal = function() {
            log('Testing showBulkAddModal()...', 'info', 'bulk-operations-log');
            try {
                songManagementModule.showBulkAddModal('/mock/directory');
                log('✅ showBulkAddModal() called successfully', 'success', 'bulk-operations-log');
            } catch (error) {
                log(`❌ showBulkAddModal() failed: ${error.message}`, 'error', 'bulk-operations-log');
            }
        };

        window.testAddSongsByPath = function() {
            log('Testing addSongsByPath()...', 'info', 'bulk-operations-log');
            try {
                songManagementModule.addSongsByPath(['/mock/file1.mp3', '/mock/file2.mp3'], 'TEST');
                log('✅ addSongsByPath() called successfully', 'success', 'bulk-operations-log');
            } catch (error) {
                log(`❌ addSongsByPath() failed: ${error.message}`, 'error', 'bulk-operations-log');
            }
        };

        window.testSaveBulkUpload = function() {
            log('Testing saveBulkUpload()...', 'info', 'bulk-operations-log');
            try {
                const mockEvent = { preventDefault: () => {} };
                songManagementModule.saveBulkUpload(mockEvent);
                log('✅ saveBulkUpload() called successfully', 'success', 'bulk-operations-log');
            } catch (error) {
                log(`❌ saveBulkUpload() failed: ${error.message}`, 'error', 'bulk-operations-log');
            }
        };

        window.testIntegration = async function() {
            log('Testing full integration...', 'info', 'integration-log');
            
            try {
                // Test all functions
                const mockEvent = { preventDefault: () => {} };
                songManagementModule.saveEditedSong(mockEvent);
                songManagementModule.saveNewSong(mockEvent);
                songManagementModule.editSelectedSong();
                songManagementModule.deleteSelectedSong();
                songManagementModule.deleteSong();
                songManagementModule.removeFromHoldingTank();
                songManagementModule.removeFromHotkey();
                songManagementModule.showBulkAddModal('/mock/directory');
                songManagementModule.addSongsByPath(['/mock/file1.mp3'], 'TEST');
                songManagementModule.saveBulkUpload(mockEvent);
                
                log('✅ All song management functions executed successfully', 'success', 'integration-log');
                log('✅ Module integration test passed', 'success', 'integration-log');
            } catch (error) {
                log(`❌ Integration test failed: ${error.message}`, 'error', 'integration-log');
            }
        };

        // Auto-load module on page load
        window.addEventListener('load', () => {
            loadModule();
        });
    </script>
</body>
</html> 